# 自定义连接池

```java
public class Pool {
    // 1. 连接池大小
    private final int poolSize;

    // 2. 链接对象数组
    private Connection[] connections;

    // 3. 连接状态数组 0 表示空闲，1 表示繁忙
    private AtomicIntegerArray states; // 原子类，保证线程安全

    // 4. 构造方法初始化

    public Pool(int poolSize) {
        this.poolSize = poolSize;
        this.connections = new Connection[poolSize];
        this.states = new AtomicIntegerArray(new int[poolSize]);
        for (int i = 0; i < poolSize; i++) {
            connections[i] = new MockConnection();
        }
    }

    // 5. 借链接
    public Connection borrow() {
        while(true) {
            for (int i = 0; i < poolSize; i++) {
                // 获取空闲链接
                if (states.get(i) == 0) {
                    if (states.compareAndSet(i,0,1)) {
                        return connections[i];
                    }
                }
            }
            // 如果没有空闲链接，当前线程进入等待
            synchronized (this) {
                try {
                    this.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }

    // 6. 归还链接
    public void free(Connection conn) {
        for (int i = 0; i < poolSize; i++) {
            if (connections[i] == conn) {
                states.set(i, 0);
                synchronized (this) {
                    this.notifyAll();
                }
                break;
            }
        }
    }
}
```